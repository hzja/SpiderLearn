# 原创
：  【kali-权限提升】(4.1)假冒令牌攻击、本地提权：流程

# 【kali-权限提升】(4.1)假冒令牌攻击、本地提权：流程

**目录**

[一、简介](#%E4%B8%80%E3%80%81%E7%AE%80%E4%BB%8B)

[1.1、概述：](#1.1%E3%80%81%E6%A6%82%E8%BF%B0%EF%BC%9A)

[ 1.2、原理：](#%C2%A01.2%E3%80%81%E5%8E%9F%E7%90%86%EF%BC%9A)

[二、使用](#%E4%BA%8C%E3%80%81%E4%BD%BF%E7%94%A8)

[2.1、第一步：建立Meterpreter 会话](#2.1%E3%80%81%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E5%BB%BA%E7%AB%8BMeterpreter%20%E4%BC%9A%E8%AF%9D)

[2.2、第二步：加载incognito模块](#2.2%E3%80%81%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E5%8A%A0%E8%BD%BDincognito%E6%A8%A1%E5%9D%97)

[2.3、第三步：列举令牌](#2.3%E3%80%81%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E5%88%97%E4%B8%BE%E4%BB%A4%E7%89%8C)

[2.4、第四步：假冒令牌攻击](#2.4%E3%80%81%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E5%81%87%E5%86%92%E4%BB%A4%E7%89%8C%E6%94%BB%E5%87%BB)

---


## 一、假冒令牌攻击

> 
<h3>1.1、概述：</h3>
令牌包括登录会话的安全信息， 如用户身份识别、用户组和用户权限。当一个用户登录Windows系统时， 它被给定一个访问令牌作为它认证会话的一部分
<hr/>
使用假冒令牌可以假冒一个网络中的另一个用户进行各种操作， 如提升用户权限、创建用户和组 等。例如，一个入侵用户可能需要以域管理员进行操作， 当它使用令牌使可假冒域管理员进行工作。提升它的访问权限后，丢弃该令牌权限


> 
<h3> 1.2、原理：</h3>
假冒令牌攻击中需要使用Kerberos协议
Kerberos协议：是一种网络认证协议， 其设计目标是通过密钥系统为客户机／服务器应用程序提供强大的认证服务

请求证书的过程：<br/> (1) 客户端向认证服务器(AS) 发送请求（证书）
(2) AS 收到请求后，将包含客户端密钥的加密证书响应发送给客户端，给服务器也发送一份， 用来使服务器认证登录客户端身份
该证书包括服务器ticket（包括服务器密钥加密的客户机身份和一份会话密钥）和一个临时加密密钥（又称为会话密钥session key)
(3) 客户端将ticket传送到服务器上，服务器确认该客户端后，便允许它登录服务器
(4)登录成功后，可以通过服务器获取到客户端的令牌（相当于查询自己的令牌）


---


---


## 二、使用

> 
<h3>2.1、第一步：建立Meterpreter 会话</h3>
为了获取一个Meterpreter Shell, 用户必须使用Metasploit去攻击一台主机后才可成功建立Meterpreter 会话


> 
<h3>2.2、第二步：加载incognito模块</h3>
use incognito
可以查看可以执行的命令和帮助信息
找到能列举令牌的命令


> 
<h3>2.3、第三步：列举令牌</h3>
例如在命令中可能找到list_tokens命令，然后对令牌进行列举
列举所有令牌
 list_tokens -u
例如有效令牌为：xxxxx\y
则xxxxx表示目标系统的主机名，y 表示登录的用户名


> 
<h3>2.4、第四步：假冒令牌攻击</h3>
impersonate_token xxxxxx\\y
假冒y用户成功，就可以通过提升自己的权限，在目标系统中进行任何操作了


---


---


## 三、本地权限提升

> 
<h3>3.1、概述：</h3>
提升本地权限可以使用户访问目标系统， 并且进行其他的操作， 如创建用户和组等。
实现本地权限提升， 也需要连接到Meterpreter会话


---


---


## 四、使用

> 
<h3>4.1、第一步：查询getsyslem提权帮助信息</h3>
getsystem -h
命令的语法格式、作用及选项


> 
<h3>4.2、第二步：使用getsystem命令提权</h3>
输入getsystem
(会自动选择方法)
该用户就拥有了目标系统中y用户的权限


> 
<h3>4.3、第三步：执行其他操作</h3>
拥有权限后
就可以执行其他操作， 如创建文件、创建用户和组等
add_user hack 123456 -h 192.168.190.149
就可以在192.168.190.149上创建hack用户了

