# 原创
：  【web-攻击用户】（9.2）防止XSS攻击

# 【web-攻击用户】（9.2）防止XSS攻击

**目录**

[一、防止XSS攻击](#%E4%B8%80%E3%80%81%E9%98%B2%E6%AD%A2XSS%E6%94%BB%E5%87%BB)

[1.1、简介：](#1.1%E3%80%81%E7%AE%80%E4%BB%8B%EF%BC%9A)

[二、防止反射型与存储型XSS漏洞](#%E4%BA%8C%E3%80%81%E9%98%B2%E6%AD%A2%E5%8F%8D%E5%B0%84%E5%9E%8B%E4%B8%8E%E5%AD%98%E5%82%A8%E5%9E%8BXSS%E6%BC%8F%E6%B4%9E)

[2.1、简述：](#2.1%E3%80%81%E7%AE%80%E8%BF%B0%EF%BC%9A)

[确认输入](#%E7%A1%AE%E8%AE%A4%E8%BE%93%E5%85%A5)

[确认输出](#%E7%A1%AE%E8%AE%A4%E8%BE%93%E5%87%BA)

[消除危险的插入点](#%E6%B6%88%E9%99%A4%E5%8D%B1%E9%99%A9%E7%9A%84%E6%8F%92%E5%85%A5%E7%82%B9)

[允许有限的HTML](#%E5%85%81%E8%AE%B8%E6%9C%89%E9%99%90%E7%9A%84HTML)

[三、防止基于DOM的XSS漏洞](#%E4%B8%89%E3%80%81%E9%98%B2%E6%AD%A2%E5%9F%BA%E4%BA%8EDOM%E7%9A%84XSS%E6%BC%8F%E6%B4%9E)

[3.1、简述：](#3.1%E3%80%81%E7%AE%80%E8%BF%B0%EF%BC%9A)

[确认输入](#%E7%A1%AE%E8%AE%A4%E8%BE%93%E5%85%A5)

[确认输出](#%E7%A1%AE%E8%AE%A4%E8%BE%93%E5%87%BA)

---


## 一、防止XSS攻击

> 
<h3>1.1、简介：</h3>
1、尽管XSS的表现形式各异，利用方法各不相同， 但概念上讲，防止这种漏洞实际上相当简单，预防它们之所以存在困难，主要在于无法确定用户可控制的数据以潜在危险的方式被处理的每一种情况。任何应用程序页面都会处理并显示一些用户数据，除核心功能外，错误消息与其他位置也可能产生漏洞。因此XSS漏洞普遍存在，即使在最为注重安全的应用程序中也是如此
2、由于造成漏洞的原因各不相同，一部分防御方法适用于反射型与存储型XSS漏洞，而另一些则适用于基于DOM的XSS漏洞


---


---


## 二、防止反射型与存储型XSS漏洞

> 
<h3>2.1、简述：</h3>
1、用户可控制的数据未经适当确认与净化就被复制到应用程序响应中、这是造成反射型与存储型XSS漏洞的根本原因。由于数据被插入到一个HTML页面的源代码中，恶意数据就会干扰这个页面，不仅修改它的内容， 还会破坏它的结构（影响引用字符串、起始与结束标签、注入脚本等）

2、为消除反射型与存储型XSS漏洞，首先必须确定应用程序中用户可控制的数据被复制到响应中的每一种情形，包括从当前请求中复制的数据以及用户之前输入的保存在应用程序中的数据，还有通过带外通道输入的数据，为确保确定每一种情形，除仔细审查应用程序的全部源代码外，没有其他更好的办法
3、确定所有可能存在XSS风险，需要适当进行防御的操作后，需要采取一种三重防御方法阻止漏洞的发生。这种方法由以下3个因素组成：确认输入、确认输出、消除危险的插入点
<hr/>
<h4>确认输入</h4>
如果应用程序在某个位置收到的用户提交的数据将来有可能被复制到它的响应中，应用程序应根据这种情形对这些数据执行尽可能严格的确认，可能需要确认的数据的特性包括：数据不是太长、仅包含某组合法字符、与一个特殊的正规表达式相匹配
<hr/>
<h4>确认输出</h4>
1、如果应用程序将某位用户或第三方提交的数据复制到它的响应中，那么应用程序应对这些数据进行HTML编码，以净化可能的恶意字符。HTML编码指用对应的HTML实体替代字面量字符。这样做可确保浏览器安全处理可能为恶意的字符， 把它们当做HTML文档的内容而非结构处理。一些经常造成问题的字符的HTML编码："(&amp;quot;)、'(&amp;#39;)、&amp;(&amp;amp;)、&lt;(&amp;lt;)、&gt;(&amp;gt;)；任何字符都可以用它的数字ASCII字符代码进行HTML编码：&amp;(&amp;#37;)、*(&amp;#42)

2、在将用户输入插入到标签属性值中时，浏览器会首先对该值进行HTML解码， 然后执行其他处理，在这种情况下，仅仅对任何在正常情况下存在问题的字符进行HTML编码的防御机制可能会失效。对于某些过滤，攻击者可以避免在有效载荷中使用HTML编码的字符

3、在将用户可控制的字符串复制到服务器的响应中之前，ASP.NET应用程序可以使用Server.HTMLEncode API净化其中的常见恶意字符，这个API把字符&amp;&lt;和&gt;转换成它们对应的HTML实体，并且使用数字形式的编码转换任何大于0x7f的ASCII字符

4、当处理用户提交的数据时，开发者常常会犯错误，即仅对在特殊情况下对攻击者有用的字符进行HTML编码，如果数据被插入到一个双引号引用的字符串中，应用程序可能只编码"字符；如果数据被插入到一个没有引号的标签中，应用程序只会编码&gt;字符。这种方法明显增加了攻击者避开确认的风险，攻击者常常利用浏览器接受无效HTML与JavaScript的弱点，改变确认情境或以意外的方式注入代码，且攻击者可以将一个攻击字符串分布到几个可控制的字段中，利用应用程序对每个字段采用的不同过滤避开其他过滤，更加可靠的方法是，无论数据插入到什么地方，始终对攻击者可能使用的每一个字符进行HTML编码，为尽可能地确保安全。开发者可能会选择HTML编码每一个非字母数字字符， 包括空白符，这种方法通常会显著增加应用程序的工作压力， 同时给任何尝试避开过滤的攻击设置巨大障碍


5、应用程序之所以结合使用输入确认与输出净化，原因在于这种方法能够提供两层防御，如果其中一层被攻破，另一层还能提供保护， 许多执行输入与输出确认的过滤都容易被攻破，结合这两种技巧， 应用程序就能够获得更多的保护，即使攻击者发现其中一种过滤存在缺陷，另一种过滤仍然能够阻止他实施攻击。在这两种防御中、输出确认更为重要，实施严格的输入确认应被视为一种次要故障恢复。
<hr/>
<h4>消除危险的插入点</h4>
1、应用程序页面中有一些位置，插入用户提交的输入就会造成极大的风险，因此开发者应力求寻找其他方法执行必要的功能。
2、应尽量避免直接在现有的JavaScript中插入用户可控制的数据。这适用于&lt;Script&gt;标签中的代码， 也适用于事件处理器的代码，如果应用程序尝试以安全的方式在其中插入数据，可能就会使攻击者有机会避开实施的防御性过滤。一旦攻击者能够控制提交数据的插入点， 可以注入任意脚本命令，从而实施恶意操作。
3、如果标签属性接受URL作为它的值，通常应用程序应该避免嵌入用户输入， 因为各种技巧也能引入脚本代码，包括伪协议脚本处理的使用

4、如果攻击者通过插入一个相关指令，或因为应用程序使用一个请求参数指定首选的字符集， 因而能够控制应用程序响应的编码类型，这些情况也应该避免。在这种情况下， 在其他方面经过精心设计的输入与输出过滤可能就会失效，因为攻击者的输入进行了不常见的编码， 以致过滤并不将其视为恶意输入，应用程序应在它的响应消息头中明确指定一种编码类型，禁止对它进行任何形式的修改，并确保应用程序的XSS过滤与其兼容
<hr/>
<h4>允许有限的HTML</h4>
1、一些应用程序需要允许用户以HTML格式提交即将插入到应用程序响应中的数据。如博客应用程序可能需要允许用户使用HTML撰写博客，对博客使用格式、嵌入链接或图像等。在这种情况下， 不作区分地应用上述措施将会导致错误。用户的HTML标记将在响应中被HTML编码，因此作为真实的标记显示在屏幕上，而不是以所需的格式化内容显示。
2、为安全地支持这种功能，应用程序需要保持稳健，仅允许有限的HTML子集，避免提供任何引入脚本代码的方法，这包括采用白名单方法，仅允许特定的标签和属性，但攻击者可以通过各种方法使用看似无害的标签来执行代码
3、有各种框架可用于确认用户提交的HTML标记，以确保其中不包含任何执行JavaScript的方法。建议需要允许用户创建有限HTML的开发者直接使用某个成熟的框架，并仔细分析其中一种框架， 以了解面临的各种相关挑战。或也可以采用某种定制的中间标记语言，允许用户使用有限的中间语言语法，然后由应用程序对其进行处理， 以生成相应的HTML标记。


---


#### 确认输出

---


#### 允许有限的HTML

---


---


## 三、防止基于DOM的XSS漏洞

> 
<h3>3.1、简述：</h3>
1、防御机制并不能防止基于DOM的XSS漏洞，因为造成这种漏洞并不需要将用户可控制的数据复制到服务器响应中。
2、应用程序应尽量避免使用客户端脚本处理DOM数据并把它插入到页面中，由于被处理的数据不在服务器的直接控制范围内，有时甚至不在它的可见范围内， 因此这种行为存在着固有的风险。
3、如果无法避免地要以这种方式使用客户端脚本，可以通过两种防御方法防止基于DOM的XSS漏洞，分别与防止反射型XSS漏洞时使用的输入与输出确认相对应
<hr/>
<h4>确认输入</h4>
1、许多时候，应用程序可以对它处理的数据执行严格的确认，客户端确认比服务器端确认更加有效。可以通过确认将要插入到文档中的数据仅包含字母数字字符与空白符，从而阻止攻击发生

2、除客户端控制外，还可以在服务器端对URL数据进行严格的确认，实施深层防御，以检测利用基于DOM的XSS漏洞的恶意请求，应用程序甚至只需实施服务器端数据确认， 通过确认以下数据来阻止攻击：查询字符串中只有一个参数、参数名为message（大小写检查）、参数值仅包含字母数字内容、确保其中井不包含任何URL片断字符。
<hr/>
<h4>确认输出</h4>
与防止反射型XSS漏洞时一样， 在将用户可控制的DOM数据插入到文档之前，应用程序也可以对它们进行HTML编码，这样就可以将各种危险的字符与表达式以安全的方式显示在页面中。


---


#### 确认输出
