# 原创
：  【web-攻击会话管理】（4.4）保障会话管理的安全：生成强大的令牌、保障令牌的安全、日志、监控与警报

# 【web-攻击会话管理】（4.4）保障会话管理的安全：生成强大的令牌、保障令牌的安全、日志、监控与警报

**目录**

[保障会话管理的安全](#%E4%BF%9D%E9%9A%9C%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86%E7%9A%84%E5%AE%89%E5%85%A8)

[1.1、生成强大的令牌](#1.1%E3%80%81%E7%94%9F%E6%88%90%E5%BC%BA%E5%A4%A7%E7%9A%84%E4%BB%A4%E7%89%8C)

[简述：](#%E7%AE%80%E8%BF%B0%EF%BC%9A)

[1.2、在整个生命周期保障令牌的安全](#1.2%E3%80%81%E5%9C%A8%E6%95%B4%E4%B8%AA%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E4%BF%9D%E9%9A%9C%E4%BB%A4%E7%89%8C%E7%9A%84%E5%AE%89%E5%85%A8)

[简述：](#%E7%AE%80%E8%BF%B0%EF%BC%9A)

[每页面令牌](#%E6%AF%8F%E9%A1%B5%E9%9D%A2%E4%BB%A4%E7%89%8C)

[1.3、日志、监控与警报](#1.3%E3%80%81%E6%97%A5%E5%BF%97%E3%80%81%E7%9B%91%E6%8E%A7%E4%B8%8E%E8%AD%A6%E6%8A%A5)

[简述：](#%E7%AE%80%E8%BF%B0%EF%BC%9A)

[反应性会话终止](#%E5%8F%8D%E5%BA%94%E6%80%A7%E4%BC%9A%E8%AF%9D%E7%BB%88%E6%AD%A2)

---


## 保障会话管理的安全

> 
<h3>1.1、生成强大的令牌</h3>
<h4>简述：</h4>
1、用于在连续请求中放新标识用户身份的令牌， 在其生成过程中， 不应给攻击者提供任何机会，使其能够以常规方式预测或推断发布给其他用户的令牌，从而从应用程序中获得大量的令牌样本。最有效的令牌生成机制应当具备以下两点
A、使用数量极其庞大的一组可能值
B、包含强大的伪随机源， 确保令牌以无法预测的方式平均分布在可能值范围内

2、只要拥有足够的时间和资源， 任何数据， 无论其长度和复杂程度如何， 都可以使用蛮力猜测出来。设计强大的令牌生成机制的目的在于，即使蓄意破坏的攻击者拥有大量带宽和处理资源， 他也绝无可能在令牌的有效期限内， 成功猜测出任何一个有效的令牌。


3、除服务器用来定位处理用户请求的相关会话对象的一个标识符外， 令牌中不应包含其他任何内容。无论是公开显示还是隐藏在几层编码或模糊处理中， 令牌都不应含有意义或采用结构。所<br/> 有关于会话所有者与状态的数据都应保存在与会话令牌对应的服务器会话对象中

4、应谨慎选择随机源。各种可用的随机源在强度上可能存在巨大的差异。和java.util.Random一样，一些随机源非常适用于各种需要不断变化的输入源的情况，但只需根据唯一 一个输出项就可以准确地推断出它的前后随机数。应研究不同的可用随机源实际使用算法的数学特性，并阅读相关文档资料，了解API的推荐用法。如果某种算法没有明确说明它具有加密安全性， 那么应认为它可被预测


5、除选择最为稳定可靠的随机源外，以与为其生成令牌请求有关的一些信息作为熵源， 也是一种良好的做法。这些信息可能并不是那个请求独有的， 但却能够非常有效地消除所使用的核心伪随机数发生器存在的任何缺陷。可被合并的信息包括：来源IP地址及接收请求的端口号，请求中的User-Agent消息头、请求时间

合并这个熵的最有效公式是建立一个特殊的字符串， 连接一个伪随机数、一串上面列出的与请求有关的数据以及一个仅服务器知道并在每次重启时重新生成的机密字符串。再使用适当的散列算法（如SHA-256算法）对这个字符串进行处理， 生成一个固定长度、便于管理的字符串， 并以它作为令牌。


> 
<h3>1.2、在整个生命周期保障令牌的安全</h3>
<h4>简述：</h4>
1、建立一个无法预测值的安全令牌后， 就必须在这个令牌生成到废止的整个生命周期中保障它的安全， 确保不会将其泄露给除令牌用户以外的其他任何人
A、令牌只能通过HTTPS传送。任何以明文形式传送的令牌都应视为被“污染”， 也就是说，不能确保用户身份不被泄露。如果使用HTTP cookie传送令牌， 应将这些cookie标记为安全，以防止用户浏览器通过HTTP传送它们。应对每个应用程序页面使用HTTPS，包括静态内容（如帮助页面、图像等）。如果仍采用HTTP服务， 那么应用程序应将任何访问敏感内容（包括登录页面）的请求项定向到HTTPS服务。帮助页面之类的静态资源一般不属于敏感内容， 不需要使用通过验证的会话即可访问，可以通过使用cookie范围指令强化cookie的使用安全， 防止在访问这些资源的请求中提交令牌
B、不能在URL中传送会话令牌，因为这样做易于受到会话固定攻击，并可能使令牌出现在各种日志机制中。开发者在禁用cookie的浏览器中使用这种技巧执行会话。然而，最好是对所有导航使用POST请求实现这一目的，并将令牌保存在HTML表单隐藏字段中
C、应总是执行退出功能。通过它删除服务器上的所有会话资源并终止会话令牌
D、会话处于非活动状态一段时间（如20分钟）后， 应执行会话终止。会话终止的效果应和用户完全退出的作用完全相同
E、应防止并行登录。每次一名用户登录， 都应发布一个新会话令牌， 同时废止任何属于该用户的现有会话。如果旧令牌被保存一段时间， 那么随后收到任何使用该令牌提出的请求，都应向用户发出安全警报，告诉他们会话已被终止， 因为他已经从其他位置登录
F、如果应用程序包含任何可以查看会话令牌的管理或诊断功能， 应对这种功能加以严密保护， 以防止未授权的访问。这种功能根本没有必要显示会话令牌，它应提供足够的与会话所有者有关的信息， 以便于执行任何支持和诊断任务。这样做就不会泄霞该用户提交的会话令牌， 使攻击者劫持他的会话
G、应尽可能限定应用程序会话cookie的域和路径范围。范围过于宽泛的cookie通常是由配置不佳的Web应用程序平台或Web 服务器生成的，而不是由应用程序开发者本人生成的。通过应用程序cookie范围中的域名或URL路径， 应无法访问其他Web应用程序或不可信的功能。应特别注意用于访问应用程序域名的任何现有子域。为了确保不会造成这种漏洞， 必须修改组织所使用的各种应用程序的域和路径命名方案，应采取特殊措施保护会话管理机制的安全， 防止应用程序用户成为各种攻击的目标。
H、应严格审查应用程序的代码库， 以确定并删除任何跨站脚本漏洞，特别是存储型XSS攻<br/> 击， 它可对每一种会话滥用与劫持防御造成破坏。
I、不应接受用户提交、但服务器并不认可的任意令牌。应立即在浏览器中取消该令牌，并将用户返回到应用程序的起始页面
J、在执行转账之类的重要操作之前， 要求进行两步确认或重新验证可有效防御跨站请求伪造和其他会话攻击
K、不完全依赖HTTP cookie传送会话令牌可防御跨站请求伪造攻击。使用cookie机制会造成这种漏洞是因为， 无论什么原因提出请求， 浏览器都会自动提交cookic。如果总是通过HTML表单隐藏字段传送令牌， 那么除非攻击者已经知道令牌， 否则他就无法建立一个表单， 再通过提交该表单执行未授权操作，如果他已经知道令牌， 就可以轻易实施劫持攻击。每页面令牌也有助于防止这些攻击
L、成功验证后应总是建立一个新的会话， 以避免会话固定攻击的影响。如果应用程序并不使用验证机制， 但允许提交敏感数据， 那么会话固定攻击造成的威胁就更难以解除。一种可能的解决办法是使提交敏感数据的页面序列尽可能短， 并且在这个序列的第一个页面建立一个新的会话（从现有会话中复制任何需要的数据， 如购物车的内容），或者使用每页面令牌防止知道第一个页面所使用的令牌的攻击者访问随后的页面。除非完全有必要， 否则不得向用户显示个人数据。即使有必要（如显示地址的“确认订单” 页面）， 也不得向用户显示信用卡号码和密码之类的敏感数据， 并且应在应用程序的响应中隐藏这些数据。
<hr/>
<h4>每页面令牌</h4>
1、应在会话令牌的基础上使用每页面令牌， 对会话实施更加严格的控制， 更有效地防御或阻断各种会话攻击。使用每页面令牌时， 每次用户请求一个应用程序页面， 应用程序都会建立一个新的页面令牌， 并通过cookie或HTML表单隐藏字段将其传送给客户端。用户每次提出一个请求， 除通过主会话令牌进行正常确认外， 页面令牌还根据最后发布的令牌值进行再次检验。如果出现不匹配的情况， 整个会话将被终止。因特网上的许多安全性至关项要的应用程序（如电子银行）， 都使用每页面令牌来强化对会话令牌机制的保护
2、虽然使用每页面令牌确实给导航造成一些限制，但它能够有效防御会话固定攻击， 并确保如果合法用户和攻击者同时使用一个被劫持的会话提出相同的请求， 该请求会立即被应用程序终止。每页面令牌还可用于追踪用户的位置和在应用程序中的活动情况， 检测出不按预定顺序访问某些功能的企图． 并有助于防止某些访问控制缺陷


#### 每页面令牌

> 
<h3>1.3、日志、监控与警报</h3>
<h4>简述：</h4>
应用程序的会话管理功能应与它的日志、监控与警报机制紧密结合， 以提供适当的反常行为记录， 并帮助管理员在必要时采取防御措施。
1、应用程序应监控包含无效令牌的请求。除非令牌很容易被预测， 否则，攻击者就符要提出大最包含无效令牌的请求，才能成功猜测出应用程序发布给其他用户的令牌， 从而在应用程序的日志中留下明显的痕迹。
2、很难完全阻止针对会话令牌的蛮力攻击， 因为我们无法通过禁用特殊用户账户或会话来终止这种攻击。一种可能的防御方法是在收到大量包含无效令牌的请求时将其来源IP地址屏蔽一段时间。然而， 如果一个用户的请求来自几个IP地址， 或者几个用户的请求来自同一个IP地址（如执行网络地址转换的代理服务器或防火墙中的用户）， 这种方法就不能发挥太大的作用
3、即使无法立即有效防止针对会话的蛮力攻击， 但保留详细的日志并向管理员发出警报仍然可帮助他们对攻击进行调查， 井尽其所能采取适当的行动
4、只要有可能， 应向用户警告与会话有关的反常事件， 例如并行登录或明显的劫持攻击（使用每页面令牌检测）。即使用户的令牌已被攻破， 这样做也可促使用户进行检查，看是否发生转账之类的未授权操作
<hr/>
<h4>反应性会话终止</h4>
1、会话管理机制可非常有效地防御许多针对应用程序的其他攻击。如果收到用户提交的反常请求（如，任何包含被修改的隐藏HTML表单字段或URL查询字符串参数的请求、任何包含与SQL注入或跨站脚本攻击有关的字符串请求、任何正常情况下已经被长度限制之类的客户端检查阻止的用户输入），那么一些安全性至关项要的应用程序（如电子银行）会极其迅速地终止用户的会话。

2、任何使用这类请求可对其加以利用的漏洞都必须从源头进行清除。但迫使用户每次提交一个无效请求时都需要进行重新验证，会显著延长探查应用程序漏洞所需的时间， 即使采用自动技巧完成这一任务也是如此。如果残余的漏洞确实存在， 其他人就更不可能发现它们。
3、如果执行这种防御， 为方便测试，建议在需要时可轻易将其关闭。如果在对应用程序进行合法渗透测试时， 这种防御就像是遇到真正的攻击者那样减缓应用程序的响应速度， 那么它的效率就会显若降低。与不使用这种机制相比，使用它很可能会在代码中造成更多的漏洞。


4、如果所攻击的应用程序使用这种防御机制， 渗透测试员可能发现在应用程序中探查各种常见的漏洞非常费时， 每次测试失败后都需要再次登录并重新导航到正在分析的位置
可以使用自动工具bp，当使用Bp intruder发动攻击时， 可以使用"获取cookie"特性在每次测试前重新登录， 并使用新的会话令牌（只要应用程序采用单阶段登录机制）。当手动浏览和探查应用程序时， 可以通过IBurpExtender接口使用Burp proxy的扩展性特性。渗透测试员可以建立一个扩展， 检测应用程序何时执行强制退出、自动登录到应用程序并将新会话和页面返回给浏览器， 同时选择使用弹出消息通知所发生的一切，虽然使用这种方法并不能完全解决这个问题， 但在某些情况下能显著减轻它造成的影响


#### 反应性会话终止
